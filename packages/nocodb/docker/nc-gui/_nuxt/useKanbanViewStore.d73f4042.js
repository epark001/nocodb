import{A as Se,z as me,cb as ke,r as S,$ as $e,i as De,Z as Ve,fC as _e,J as P,K as C,f as Pe,f9 as re}from"./entry.13466615.js";import{b as Ke,S as Ae}from"./index.5263eb1d.js";import{d as Fe}from"./deepCompare.d32ec333.js";import{e as K,r as X}from"./dataUtils.31dbfaee.js";import{a as je,f as Ce,p as qe}from"./useMetas.223da623.js";import{a as xe,b as Ee}from"./useSmartsheetStore.9bdf3b91.js";import{u as Ie}from"./index.2a3da6a9.js";import{u as ze}from"./useSharedView.746b4f21.js";import{u as Je}from"./index.e7cf7635.js";const[Xe,Ne]=Ie((n,r,ce=!1)=>{var ie;if(!n)throw new Error("Table meta is not available");const{t:Y}=Se(),{api:q}=me(),{project:g,sqlUis:M}=ke(je()),{$e:de,$api:A}=Pe(),{sorts:J,nestedFilters:N}=xe(),{sharedView:ee,fetchSharedViewData:ve,fetchSharedViewGroupedData:fe}=ze(),{isUIAllowed:U}=Je(),D=S(ce)||$e(Ke,S(!1)),pe=S(null),{search:x}=Ee(),{addUndo:B,clone:F,defineViewScope:G}=Ce(),H=S([]),we=S((ie=n.value)!=null&&ie.base_id?M.value[n.value.base_id]:Object.values(M.value)[0]),L=De(()=>{var l,a,o,s;let e;const t=((a=(l=n.value)==null?void 0:l.columns)==null?void 0:a.find(({id:i})=>i===x.value.field))||((s=(o=n.value)==null?void 0:o.columns)==null?void 0:s.find(i=>i.pv));if(t&&x.value.query.trim())return["text","string"].includes(we.value.getAbstractType(t))&&t.dt!=="bigint"?e=`(${t.title},like,%${x.value.query.trim()}%)`:e=`(${t.title},eq,${x.value.query.trim()})`,e});Ve(Ae,pe);const V=S({}),_=S([]),u=S(new Map),d=S(new Map),p=S(""),b=S(),h=S({}),ae=S(!1),le=e=>e.map(t=>({row:{...t},oldRow:{...t},rowMeta:{}}));async function ge(){var t,l,a,o;if((!((t=g==null?void 0:g.value)!=null&&t.id)||!((l=n.value)!=null&&l.id)||!((a=r==null?void 0:r.value)!=null&&a.id)||!((o=b==null?void 0:b.value)!=null&&o.id))&&!D.value)return;u.value=new Map,d.value=new Map;let e;D.value?e=await fe(b.value.id,{sortsArr:J.value,filtersArr:N.value}):e=await q.dbViewRow.groupedDataList("noco",g.value.id,n.value.id,r.value.id,b.value.id,{where:L.value},{});for(const s of e??[]){const i=s.key;u.value.set(i,le(s.value.list)),d.value.set(i,s.value.pageInfo.totalRows||0)}}async function be(e,t={}){var o,s,i;if((!((o=g==null?void 0:g.value)!=null&&o.id)||!((s=n.value)!=null&&s.id)||!((i=r.value)!=null&&i.id))&&!D.value)return;let l=`(${p.value},eq,${e})`;e===null&&(l=`(${p.value},is,null)`),L.value&&(l=`${l} and ${L.value}`);const a=D.value?await ve({...t,sortsArr:J.value,filtersArr:N.value,offset:t.offset,where:l}):await q.dbViewRow.list("noco",g.value.id,n.value.id,r.value.id,{...t,...U("sortSync")?{}:{sortArrJson:JSON.stringify(J.value)},...U("filterSync")?{}:{filterArrJson:JSON.stringify(N.value)},where:l});u.value.set(e,[...u.value.get(e),...le(a.list)])}async function ye(){var l,a,o,s,i,f,O,m,R;if(!((l=r==null?void 0:r.value)!=null&&l.id)||!((a=n==null?void 0:n.value)!=null&&a.columns))return;V.value=D.value?(o=ee.value)==null?void 0:o.view:await A.dbView.kanbanRead(r.value.id),b.value=D.value?qe((s=ee.value)==null?void 0:s.meta).groupingFieldColumn:n.value.columns.filter(c=>c.id===V.value.fk_grp_col_id)[0]||{},p.value=b.value.title;const{fk_grp_col_id:e,meta:t}=V.value;if(h.value=t?JSON.parse(t):{},h.value&&e&&h.value[e]){let c=!1,y=!1;for(const v of((i=b.value.colOptions)==null?void 0:i.options)??[]){const $=h.value[e].findIndex(I=>I.id===v.id);if($!==-1){const{collapsed:I,...z}=h.value[e][$];Fe(z,v)||(h.value[e][$]={...h.value[e][$],...v},v.title!==z.title&&(u.value.set(v.title,u.value.get(z.title)),d.value.set(v.title,d.value.get(z.title)),await Z(v.title)),c=!0)}else h.value[e].push({...v,collapsed:!1}),u.value.set(v.title,[]),d.value.set(v.title,0),c=!0,y=!0}const k=(O=(f=b.value)==null?void 0:f.colOptions)==null?void 0:O.options.map(({id:v})=>v),w=h.value[e].filter(({id:v})=>v!=="uncategorized"&&!k.includes(v));for(const v of w){const $=h.value[e].map(I=>I.id).indexOf(v.id);$!==-1&&(h.value[e].splice($,1),u.value.size&&d.value.size&&u.value.has(v.title)&&(await Z(v.title,!0),u.value.set(null,[...u.value.get(null)||[],...u.value.get(v.title)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(v.title)||0))),c=!0)}_.value=h.value[e],c&&(await E(),y&&(ae.value=!0))}else _.value=[...((R=(m=b.value)==null?void 0:m.colOptions)==null?void 0:R.options)??[],{id:"uncategorized",title:null,order:0,color:_e.light[2]}].sort((c,y)=>c.order-y.order).map(c=>({...c,collapsed:!1})),await E()}async function E(){const{fk_grp_col_id:e}=V.value;e&&(h.value[e]=_.value,await te({meta:h.value}))}async function te(e){var t;!((t=r==null?void 0:r.value)!=null&&t.id)||!U("xcDatatableEditable")||await A.dbView.kanbanUpdate(r.value.id,e)}function Q(e){var l;const t=X(e,(l=n==null?void 0:n.value)==null?void 0:l.columns);for(const a of u.value.values())for(const o of a)if(Object.keys(t).every(s=>t[s]===o.row[s]))return o}async function T(e,t=u.value.get(null).length,l=!1){var a,o,s,i,f;try{const O=((a=n==null?void 0:n.value)==null?void 0:a.columns).reduce((R,c)=>((!c.ai||l)&&(e==null?void 0:e[c.title])!==null&&(R[c.title]=e==null?void 0:e[c.title]),R),{}),m=await A.dbViewRow.create(re,g==null?void 0:g.value.id,(o=n.value)==null?void 0:o.id,(s=r==null?void 0:r.value)==null?void 0:s.id,O);if(!l){const R=K(m,(i=n.value)==null?void 0:i.columns);B({redo:{fn:async function(y,k){var v;const w=X(y.row,(v=n.value)==null?void 0:v.columns);y.row={...w,...y.row},await T(y,k,!0),j(y,!0)},args:[F(e),t]},undo:{fn:async function(y){await se(y);const k=Q(m);k&&ue(k)},args:[R]},scope:G({view:r.value})})}return(f=u.value.get(null))==null||f.splice(t??0,1,{row:m,rowMeta:{},oldRow:{...m}}),m}catch(O){P.error(await C(O))}}async function W(e,t,l=!1){var a,o,s;try{const i=K(e.row,(a=n==null?void 0:n.value)==null?void 0:a.columns),f=await A.dbViewRow.update(re,g==null?void 0:g.value.id,(o=n.value)==null?void 0:o.id,(s=r==null?void 0:r.value)==null?void 0:s.id,i,{[t]:e.row[t]});if(!l){const O=H.value.find(R=>R.op==="removed"&&R.pk===i),m=H.value.find(R=>R.op==="added"&&R.pk===i);B({redo:{fn:async function(c,y){const k=await W(c,y,!0),w=Q(c.row);w&&(Object.assign(w.row,k),w.row[p.value]!==w.oldRow[p.value]&&j(w,!1,m==null?void 0:m.index),Object.assign(w.oldRow,k))},args:[F(e),t]},undo:{fn:async function(c,y){const k=await W({row:c.oldRow,oldRow:c.row,rowMeta:c.rowMeta},y,!0),w=Q(c.row);w&&(Object.assign(w.row,k),w.row[p.value]!==w.oldRow[p.value]&&j(w,!1,O==null?void 0:O.index),Object.assign(w.oldRow,k))},args:[F(e),t]},scope:G({view:r.value})}),Object.assign(e.row,f),Object.assign(e.oldRow,f)}return f}catch(i){P.error(`${Y("msg.error.rowUpdateFailed")} ${await C(i)}`)}}async function he(e){e.rowMeta.new?await T(e.row,u.value.get(e.row.title).indexOf(e)):await W(e,p.value)}async function Z(e,t=!1){var l;try{const a=t?null:e;await q.dbTableRow.bulkUpdateAll("noco",g.value.id,(l=n.value)==null?void 0:l.id,{[p.value]:a},{where:`(${p.value},eq,${e})`}),u.value.has(e)&&u.value.set(e,u.value.get(e).map(o=>({...o,row:{...o.row,[p.value]:a},oldRow:{...o.oldRow,[p.value]:o.row[p.value]}})))}catch(a){P.error(await C(a))}}async function Re(e,t){var l;if(!(!((l=r==null?void 0:r.value)!=null&&l.id)||!b.value))try{await Z(e,!0),u.value.set(null,[...u.value.get(null),...u.value.get(e)]),d.value.set(null,(d.value.get(null)||0)+(d.value.get(e)||0)),u.value.delete(e),d.value.delete(e);const a=b.value.colOptions.options.filter(o=>o.title!==e);b.value.colOptions.options=a,await q.dbTableColumn.update(b.value.id,{...b.value,colOptions:{options:a}}),_.value.splice(t,1),h.value[V.value.fk_grp_col_id]=_.value,await E(),de("a:kanban:delete-stack")}catch(a){P.error(await C(a))}}function Oe(e=u.value.get(null).length){return u.value.get(null).splice(e,0,{row:{},oldRow:{},rowMeta:{new:!0}}),u.value.get(null)[e]}function j(e,t,l){const a=e.row[p.value],o=e.oldRow[p.value];if(t)a&&(l!==void 0?u.value.get(a).splice(l,0,e):u.value.get(a).push(e),d.value.set(a,d.value.get(a)+1),oe());else{const s=K(e.row,n.value.columns),i=u.value.get(o).findIndex(f=>K(f.row,n.value.columns)===s);if(i!==-1)if(a!==o){d.value.set(o,d.value.get(o)-1);const f=u.value.get(o);if(f.splice(i,1),u.value.set(o,f),d.value.set(a,d.value.get(a)+1),l!==void 0){const O=u.value.get(a);O.splice(l,0,e),u.value.set(a,O)}else u.value.set(a,[...u.value.get(a),e])}else{const f=u.value.get(a);l!==void 0?(f.splice(i,1),f.splice(l,0,e)):f[i]=e,u.value.set(o,f)}}}function ue(e){const t=K(e.row,n.value.columns),l=e.row[p.value];u.value.set(l,u.value.get(l).filter(a=>K(a.row,n.value.columns)!==t)),d.value.set(l,d.value.get(l)-1)}function oe(){u.value.get(null).pop(),d.value.set(null,d.value.get(null)-1)}async function ne(e,t=!1){var l,a;try{if(t||B({redo:{fn:async function(s){await ne(s,!0)},args:[F(e)]},undo:{fn:async function(s){var f;const i=X(s.row,(f=n.value)==null?void 0:f.columns);s.row={...i,...s.row},await T(s.row,void 0,!0),j(s,!0)},args:[F(e)]},scope:G({view:r.value})}),!e.rowMeta.new){const o=(a=(l=n==null?void 0:n.value)==null?void 0:l.columns)==null?void 0:a.filter(i=>i.pk).map(i=>e.row[i.title]).join("___");if(!await se(o))return}ue(e)}catch(o){P.error(`${Y("msg.error.deleteRowFailed")}: ${await C(o)}`)}}async function se(e){var l,a;if(!e)throw new Error("Delete not allowed for table which doesn't have primary Key");const t=await A.dbViewRow.delete("noco",g.value.id,(l=n.value)==null?void 0:l.id,(a=r.value)==null?void 0:a.id,encodeURIComponent(e));return t.message?(P.info(`Row delete failed: ${`Unable to delete row with ID ${e} because of the following:
              
${t.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}return{loadKanbanData:ge,loadMoreKanbanData:be,loadKanbanMeta:ye,updateKanbanMeta:te,kanbanMetaData:V,formattedData:u,countByStack:d,groupingField:p,groupingFieldColOptions:_,groupingFieldColumn:b,updateOrSaveRow:he,addEmptyRow:Oe,addOrEditStackRow:j,deleteStack:Re,updateKanbanStackMeta:E,removeRowFromUncategorizedStack:oe,shouldScrollToRight:ae,deleteRow:ne,moveHistory:H}},"kanban-view-store");function Ye(){const n=Ne();if(n==null)throw new Error("Please call `useProvideKanbanViewStore` on the appropriate parent component");return n}export{Ye as a,Xe as u};
