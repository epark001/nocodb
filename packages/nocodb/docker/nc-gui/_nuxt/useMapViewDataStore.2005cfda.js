import{r as u,z as N,cb as U,$ as j,i as k,f9 as O,J as q,K as F,f as $}from"./entry.13466615.js";import{u as K}from"./index.e7cf7635.js";import{a as B}from"./useSmartsheetStore.9bdf3b91.js";import{u as G}from"./useSharedView.746b4f21.js";import{p as H}from"./dataUtils.31dbfaee.js";import{b as L}from"./index.5263eb1d.js";import{u as Q}from"./index.2a3da6a9.js";import{a as W,u as X}from"./useMetas.223da623.js";const Y=s=>s.map(o=>({row:{...o},oldRow:{...o},rowMeta:{}})),[ea,Z]=Q((s,o,P=!1,e)=>{if(!s)throw new Error("Table meta is not available");const g=1e3,l=u([]),{api:R}=N(),{project:n}=U(W()),{$api:d}=$(),{isUIAllowed:w}=K(),c=u(P)||j(L,u(!1)),{sorts:I,nestedFilters:S}=B(),{sharedView:h,fetchSharedViewData:z}=G(),f=u({}),b=u(),p=u({page:1,pageSize:g}),A=k(()=>({limit:p.value.pageSize??g,where:(e==null?void 0:e.value)??""}));async function y(){var t,r,i;const{count:a}=await d.dbViewRow.count(O,(t=n==null?void 0:n.value)==null?void 0:t.title,(r=s==null?void 0:s.value)==null?void 0:r.id,(i=o==null?void 0:o.value)==null?void 0:i.id);p.value.totalRows=a}async function E(){var a,t,r;!((a=o==null?void 0:o.value)!=null&&a.id)||!((t=s==null?void 0:s.value)!=null&&t.columns)||(f.value=c.value?(r=h.value)==null?void 0:r.view:await d.dbView.mapRead(o.value.id),b.value=s.value.columns.filter(i=>i.id===f.value.fk_geo_data_col_id)[0]||{})}async function x(){var t,r,i;if((!((t=n==null?void 0:n.value)!=null&&t.id)||!((r=s.value)!=null&&r.id)||!((i=o.value)!=null&&i.id))&&!(c!=null&&c.value))return;const a=c.value?await z({sortsArr:I.value,filtersArr:S.value}):await R.dbViewRow.list("noco",n.value.id,s.value.id,o.value.id,{...A.value,...w("filterSync")?{}:{filterArrJson:JSON.stringify(S.value)},where:e==null?void 0:e.value});l.value=Y(a.list)}async function C(a){var t;!((t=o==null?void 0:o.value)!=null&&t.id)||!w("xcDatatableEditable")||await d.dbView.mapUpdate(o.value.id,a)}const{getMeta:T}=X();async function V(a,t={},{metaValue:r=s.value,viewMetaValue:i=o.value}={}){const D=a.row;a.rowMeta&&(a.rowMeta.saving=!0);try{const{missingRequiredColumns:v,insertObj:J}=await H({meta:r,ltarState:t,getMeta:T,row:D});if(v.size)return;const m=await d.dbViewRow.create(O,n==null?void 0:n.value.id,r==null?void 0:r.id,i==null?void 0:i.id,J);return Object.assign(a,{row:{...m,...D},rowMeta:{...a.rowMeta||{},new:void 0},oldRow:{...m}}),y(),m}catch(v){q.error(await F(v))}finally{a.rowMeta&&(a.rowMeta.saving=!1)}}function _(a=l.value.length){return l.value.splice(a,0,{row:{},oldRow:{},rowMeta:{new:!0}}),l.value[a]}return{formattedData:l,loadMapData:x,loadMapMeta:E,updateMapMeta:C,mapMetaData:f,geoDataFieldColumn:b,addEmptyRow:_,insertRow:V,syncCount:y,paginationData:p}});function ua(){const s=Z();if(s==null)throw new Error("Please call `useProvideMapViewStore` on the appropriate parent component");return s}export{ua as a,ea as u};
