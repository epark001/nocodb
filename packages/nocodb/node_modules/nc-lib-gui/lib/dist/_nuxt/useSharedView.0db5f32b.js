import{a as x,u as j,p as M}from"./useMetas.ba7abae7.js";import{S as N}from"./index.5263eb1d.js";import{r as V,S as O,cb as z,cm as d,Z as C,i as I,fb as L,cd as n,f as F}from"./entry.51f4e399.js";function _(){const c=V([]),{appInfo:A}=O(),g=x(),{project:J}=z(g),h=A.value.defaultLimit||25,l=d("paginationData",()=>({page:1,pageSize:h})),r=d("sharedView",()=>{}),p=V([]),i=d("password",()=>{});C(N,i);const m=d("allowCSVDownload",()=>!1),f=d("meta",()=>{}),b=I(()=>{var a,t;return((t=(a=f.value)==null?void 0:a.columns)==null?void 0:t.filter(e=>e.show&&e.uidt!==n.Rollup&&e.uidt!==n.Lookup&&e.uidt!==n.Formula&&e.uidt!==n.Barcode&&e.uidt!==n.QrCode).sort((e,s)=>e.order-s.order).map(e=>({...e,required:!!e.required})))??[]}),{$api:v}=F(),{setMeta:y}=j();return{sharedView:r,loadSharedView:async(a,t=void 0)=>{var w,S;const e=await v.public.sharedViewMetaGet(a,{headers:{"xc-password":t??i.value}});try{m.value=(w=M(e.meta))==null?void 0:w.allowCSVDownload}catch{m.value=!1}t&&(i.value=t),r.value={title:"",...e},f.value={...e.model};let s=1;f.value.columns=[...e.model.columns].filter(o=>o.show).map(o=>({...o,order:s++})).sort((o,D)=>o.order-D.order),await y(e.model),(S=J.value)!=null&&S.bases||g.setProject({id:e.project_id,bases:[{id:e.base_id,type:e.client}]});const u={...e.relatedMetas};Object.keys(u).forEach(o=>y(u[o]))},meta:f,nestedFilters:c,fetchSharedViewData:async a=>{var t;if(!r.value)return{list:[],pageInfo:{}};if(!a.offset){const e=l.value.page||1,s=l.value.pageSize||h;a.offset=(e-1)*s}return await v.public.dataList(r.value.uuid,{limit:((t=r.value)==null?void 0:t.type)===L.MAP?1e3:void 0,...a,filterArrJson:JSON.stringify(a.filtersArr??c.value),sortArrJson:JSON.stringify(a.sortsArr??p.value)},{headers:{"xc-password":i.value}})},fetchSharedViewGroupedData:async(a,{sortsArr:t,filtersArr:e})=>{if(!r.value)return;const s=l.value.page||1,u=l.value.pageSize||h;return await v.public.groupedDataList(r.value.uuid,a,{offset:(s-1)*u,filterArrJson:JSON.stringify(e??c.value),sortArrJson:JSON.stringify(t??p.value)},{headers:{"xc-password":i.value}})},paginationData:l,sorts:p,exportFile:async(a,t,e,s,{sortsArr:u,filtersArr:w}={sortsArr:[],filtersArr:[]})=>await v.public.csvExport(r.value.uuid,e,{format:s,query:{fields:a.map(S=>S.title),offset:t,filterArrJson:JSON.stringify(w??c.value),sortArrJson:JSON.stringify(u??p.value)},headers:{"xc-password":i.value}}),formColumns:b,allowCSVDownload:m}}export{_ as u};
