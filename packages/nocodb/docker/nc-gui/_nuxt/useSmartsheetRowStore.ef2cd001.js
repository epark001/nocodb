import{A as N,cb as P,r as I,i as M,E as h,J as A,eW as k,f4 as B,f9 as y,K as _,f as F}from"./entry.13466615.js";import{d as G}from"./deepCompare.d32ec333.js";import{e as f}from"./dataUtils.31dbfaee.js";import{i as T,a as S,b as O}from"./virtualCell.88c63e03.js";import{u as H}from"./index.2a3da6a9.js";import{a as J,u as K}from"./useMetas.223da623.js";const[V,W]=H((l,v)=>{const{$api:w}=F(),{t:x}=N(),{project:p}=P(J()),{metas:b}=K(),d=I(v),s=I({}),L=M(()=>h(v).rowMeta.new??!1),U=async(t,e)=>{if(T(e)||S(e)){if(s.value[e.title]||(s.value[e.title]=[]),s.value[e.title].find(o=>G(o,t)))return A.info(x("msg.info.valueAlreadyInList"));Array.isArray(t)?s.value[e.title].push(...t):s.value[e.title].push(t)}else O(e)&&(s.value[e.title]=t)},g=async(t,e)=>{var o,a;T(e)||S(e)?(a=s.value[e.title])==null||a.splice((o=s.value[e.title])==null?void 0:o.indexOf(t),1):O(e)&&(s.value[e.title]=null)},C=async(t,e,o,a,{metaValue:n=l.value}={})=>{try{await w.dbTableRow.nestedAdd(y,p.value.id,n==null?void 0:n.id,encodeURIComponent(t),a,o.id,encodeURIComponent(e))}catch(c){A.error(await _(c))}};return{row:v,state:s,isNew:L,addLTARRef:U,removeLTARRef:g,syncLTARRefs:async(t,{metaValue:e=l.value}={})=>{var a,n,c,R;const o=f(t,e==null?void 0:e.columns);for(const r of(e==null?void 0:e.columns)??[]){if(!k(r))continue;const i=r.colOptions,u=(a=b.value)==null?void 0:a[i==null?void 0:i.fk_related_model_id];if(T(r)||S(r)){const j=((n=s.value)==null?void 0:n[r.title])??[];for(const E of j)await C(o,f(E,u.columns),r,i.type,{metaValue:e})}else O(r)&&((c=s.value)!=null&&c[r.title])&&await C(o,f((R=s.value)==null?void 0:R[r.title],u.columns),r,i.type,{metaValue:e});s.value[r.title]=null}},loadRow:async()=>{var e,o,a,n;const t=await w.dbTableRow.read(y,(e=p.value)==null?void 0:e.id,(o=l.value)==null?void 0:o.title,encodeURIComponent(f((a=h(v))==null?void 0:a.row,(n=l.value)==null?void 0:n.columns)));Object.assign(h(v),{row:t,oldRow:{...t},rowMeta:{}})},currentRow:d,clearLTARCell:async t=>{var e,o,a,n,c,R,r;try{if(!t||!k(t))return;const i=(o=b.value)==null?void 0:o[(e=t==null?void 0:t.colOptions)==null?void 0:e.fk_related_model_id];if(L.value)s.value[t.title]=null;else if(d.value)if(((a=t.colOptions)==null?void 0:a.type)===B.BELONGS_TO){if(!d.value.row[t.title])return;await w.dbTableRow.nestedRemove(y,p.value.id,(n=l.value)==null?void 0:n.id,f(d.value.row,(c=l.value)==null?void 0:c.columns),"bt",t.id,f(d.value.row[t.title],i==null?void 0:i.columns)),d.value.row[t.title]=null}else{for(const u of d.value.row[t.title]||[])await w.dbTableRow.nestedRemove(y,p.value.id,(R=l.value)==null?void 0:R.id,encodeURIComponent(f(d.value.row,(r=l.value)==null?void 0:r.columns)),(t==null?void 0:t.colOptions).type,t.id,encodeURIComponent(f(u,i==null?void 0:i.columns)));d.value.row[t.title]=[]}}catch(i){A.error(await _(i))}}}},"smartsheet-row-store");function ee(){const l=W();if(l==null)throw new Error("Please call `useSmartsheetRowStore` on the appropriate parent component");return l}export{ee as a,V as u};
