import{A as D,S as ee,b as te}from"./index.5263eb1d.js";import{u as ae,a as ie,f as se}from"./useMetas.ba7abae7.js";import{cb as re,$ as x,r as I,B as M,A as le,i as f,aq as Q,g as ne,f9 as $,J as R,K as L,P as oe,f as ue}from"./entry.51f4e399.js";import{u as de}from"./index.b9981e09.js";import{u as ve}from"./useSharedView.0db5f32b.js";const[we,ce]=de((s,m,y,u=b=>{})=>{var J,G,H;const{metas:b,getMeta:W}=ae(),{project:g}=re(ie()),{$api:d}=ue(),A=x(D,I()),{addUndo:V,clone:k,defineViewScope:E}=se(),O=x(ee,I(null)),_=I(),S=I(),l=M({page:1,query:"",size:10}),o=M({page:1,query:"",size:10}),{t:P}=le(),F=x(te,I(!1)),v=f(()=>{var e;return(e=s.value)==null?void 0:e.colOptions}),{sharedView:T}=ve(),z=((J=g.value)==null?void 0:J.id)||((H=(G=T.value)==null?void 0:G.view)==null?void 0:H.project_id),p=f(()=>{var e,t;return(t=b==null?void 0:b.value)==null?void 0:t[(e=s==null?void 0:s.value)==null?void 0:e.fk_model_id]}),n=f(()=>{var e,t;return(t=b.value)==null?void 0:t[(e=v.value)==null?void 0:e.fk_related_model_id]}),h=f(()=>p.value.columns.filter(e=>e.pk).map(e=>{var t,i;return(i=(t=m==null?void 0:m.value)==null?void 0:t.row)==null?void 0:i[e.title]}).join("___")),q=e=>{var t,i;return(i=(t=n.value)==null?void 0:t.columns)==null?void 0:i.filter(a=>a.pk).map(a=>e==null?void 0:e[a.title]).join("___")},X=async()=>{await W(v.value.fk_related_model_id)},c=f(()=>{var e,t,i,a,r;return((r=((t=(e=n.value)==null?void 0:e.columns)==null?void 0:t.find(w=>w.pv))||((a=(i=n==null?void 0:n.value)==null?void 0:i.columns)==null?void 0:a[0]))==null?void 0:r.title)||""}),K=f(()=>{var e,t,i;return((i=(t=(e=n.value)==null?void 0:e.columns)==null?void 0:t.filter(a=>a.pk))==null?void 0:i.map(a=>a.title))??[]}),Y=f(()=>{var e,t,i,a,r;return(r=((t=(e=p.value)==null?void 0:e.columns)==null?void 0:t.find(w=>w.pv))||((a=(i=n==null?void 0:n.value)==null?void 0:i.columns)==null?void 0:a[0]))==null?void 0:r.title}),B=async()=>{var e,t;try{if(F.value){const a=ne().currentRoute;_.value=await d.public.dataRelationList(a.value.params.viewId,s.value.id,{},{headers:{"xc-password":O.value},query:{limit:l.size,offset:l.size*(l.page-1),where:l.query&&`(${c.value},like,${l.query})`,fields:[c.value,...K.value]}})}else y!=null&&y.value?_.value=await d.dbTableRow.list($,z,(e=n==null?void 0:n.value)==null?void 0:e.id,{limit:l.size,offset:l.size*(l.page-1),where:l.query&&`(${c.value},like,${l.query})`,fields:[c.value,...K.value]}):_.value=await d.dbTableRow.nestedChildrenExcludedList($,z,p.value.id,encodeURIComponent(h.value),v.value.type,(t=s==null?void 0:s.value)==null?void 0:t.id,{limit:String(l.size),offset:String(l.size*(l.page-1)),where:l.query&&`(${c.value},like,${l.query})`})}catch(i){R.error(`${P("msg.error.failedToLoadList")}: ${await L(i)}`)}},C=async()=>{var e,t,i,a,r,w;try{if(v.value.type==="bt")return;F.value?S.value=await d.public.dataNestedList((e=T.value)==null?void 0:e.uuid,encodeURIComponent(h.value),v.value.type,(t=s==null?void 0:s.value)==null?void 0:t.id,{limit:String(o.size),offset:String(o.size*(o.page-1)),where:o.query&&`(${c.value},like,${o.query})`},{headers:{"xc-password":O.value}}):S.value=await d.dbTableRow.nestedList($,((i=g==null?void 0:g.value)==null?void 0:i.id)||((r=(a=T.value)==null?void 0:a.view)==null?void 0:r.project_id),p.value.id,encodeURIComponent(h.value),v.value.type,(w=s==null?void 0:s.value)==null?void 0:w.id,{limit:String(o.size),offset:String(o.size*(o.page-1)),where:o.query&&`(${c.value},like,${o.query})`})}catch(N){R.error(`${P("msg.error.failedToLoadChildrenList")}: ${await L(N)}`)}},Z=async(e,t)=>{oe.confirm({title:"Do you want to delete the record?",type:"warning",onOk:async()=>{const i=q(e);try{const a=await d.dbTableRow.delete($,z,n.value.id,encodeURIComponent(i));if(a.message)return R.info(`Row delete failed: ${`Unable to delete row with ID ${i} because of the following:
              
${a.message.join(`
`)}.

              Clear the data first & try again`})}`),!1;u==null||u(!1),y!=null&&y.value||await C(),t==null||t(e)}catch(a){R.error(`${P("msg.error.deleteFailed")}: ${await L(a)}`)}}})},j=async(e,{metaValue:t=p.value}={},i=!1)=>{var a;try{await d.dbTableRow.nestedRemove($,g.value.id,t.id,encodeURIComponent(h.value),v.value.type,(a=s==null?void 0:s.value)==null?void 0:a.id,encodeURIComponent(q(e))),i||V({redo:{fn:r=>j(r,{},!0),args:[k(e)]},undo:{fn:r=>U(r,{},!0),args:[k(e)]},scope:E({view:A.value})})}catch(r){R.error(`${P("msg.error.unlinkFailed")}: ${await L(r)}`)}u==null||u(!1)},U=async(e,{metaValue:t=p.value}={},i=!1)=>{var a;try{await d.dbTableRow.nestedAdd($,g.value.id,t.id,encodeURIComponent(h.value),v.value.type,(a=s==null?void 0:s.value)==null?void 0:a.id,encodeURIComponent(q(e))),await C(),i||V({redo:{fn:r=>U(r,{},!0),args:[k(e)]},undo:{fn:r=>j(r,{},!0),args:[k(e)]},scope:E({view:A.value})})}catch(r){R.error(`Linking failed: ${await L(r)}`)}u==null||u(!1)};return Q(l,async()=>{await B()}),Q(o,async()=>{await C()}),{relatedTableMeta:n,loadRelatedTableMeta:X,relatedTableDisplayValueProp:c,childrenExcludedList:_,childrenList:S,rowId:h,childrenExcludedListPagination:l,childrenListPagination:o,displayValueProp:Y,meta:p,unlink:j,link:U,loadChildrenExcludedList:B,loadChildrenList:C,row:m,deleteRelatedRow:Z,getRelatedTableRowId:q}},"ltar-store");function $e(){const s=ce();if(s==null)throw new Error("Please call `useLTARStore` on the appropriate parent component");return s}export{$e as a,we as u};
