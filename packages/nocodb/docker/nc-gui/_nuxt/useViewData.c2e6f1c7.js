import{u as Pe,f as _e,a as ye}from"./useMetas.223da623.js";import{i as xe,a as Ce,b as Oe}from"./virtualCell.88c63e03.js";import{A as ce,cb as Se,i as de,f9 as V,J as U,K as W,cd as q,cc as le,f as De,cm as je,z as me,g as $e,S as Te,r as Z,$ as Ae,fb as Me,fD as Re}from"./entry.13466615.js";import{p as Fe,e as G,r as F,f as H}from"./dataUtils.31dbfaee.js";import{b as Ee}from"./index.5263eb1d.js";import{u as Ne}from"./useSharedView.746b4f21.js";import{a as Be}from"./useSmartsheetStore.9bdf3b91.js";import{u as Ue}from"./index.e7cf7635.js";function Le(C){const{meta:t,viewMeta:_,formattedData:w,paginationData:f,callbacks:e}=C;if(!t)throw new Error("Table meta is not available");const{t:b}=ce(),{getMeta:we,metas:ee}=Pe(),{addUndo:K,clone:A,defineViewScope:M}=_e(),{project:E}=Se(ye()),{$api:L}=De(),oe=de({get(){return!!w.value.length&&w.value.every(o=>o.rowMeta.selected)},set(o){w.value.forEach(a=>a.rowMeta.selected=o)}});function ne(o=w.value.length){return w.value.splice(o,0,{row:{},oldRow:{},rowMeta:{new:!0}}),w.value[o]}async function Q(o,a={},{metaValue:n=t.value,viewMetaValue:v=_.value}={},d=!1){var S,D;const c=o.row;o.rowMeta&&(o.rowMeta.saving=!0);try{const{missingRequiredColumns:s,insertObj:i}=await Fe({meta:n,ltarState:a,getMeta:we,row:c,undo:d});if(s.size)return;const r=await L.dbViewRow.create(V,E==null?void 0:E.value.id,n==null?void 0:n.id,v==null?void 0:v.id,i);if(!d){Object.assign(o,{row:{...r,...c},rowMeta:{...o.rowMeta||{},new:void 0},oldRow:{...r}});const u=G(r,n==null?void 0:n.columns),g=F(r,n==null?void 0:n.columns),p=H(g,w.value);K({redo:{fn:async function(l,h,x){var ae,se;l.row={...g,...l.row};const k=await Q(l,h,void 0,!0);p!==-1&&x.pageSize===f.value.pageSize?x.page===f.value.page?w.value.splice(p,0,{row:{...l,...k},rowMeta:l.rowMeta,oldRow:l.oldRow}):await((ae=e==null?void 0:e.changePage)==null?void 0:ae.call(e,x.page)):await((se=e==null?void 0:e.loadData)==null?void 0:se.call(e))},args:[A(o),A(a),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(l){await B(l),p!==-1&&w.value.splice(p,1),f.value.totalRows=f.value.totalRows-1},args:[u]},scope:M({view:_.value})})}return await((S=e==null?void 0:e.syncCount)==null?void 0:S.call(e)),r}catch(s){U.error(await W(s))}finally{o.rowMeta&&(o.rowMeta.saving=!1),await((D=e==null?void 0:e.globalCallback)==null?void 0:D.call(e))}}async function m(o,a,{metaValue:n=t.value,viewMetaValue:v=_.value}={},d=!1){var c;o.rowMeta&&(o.rowMeta.saving=!0);try{const S=G(o.row,n==null?void 0:n.columns),D=await L.dbViewRow.update(V,E==null?void 0:E.value.id,n==null?void 0:n.id,v==null?void 0:v.id,S,{[a]:o.row[a]??null});return d||(K({redo:{fn:async function(i,r,u){var p,R,l;const g=await m(i,r,void 0,!0);if(u.page===f.value.page&&u.pageSize===f.value.pageSize){const h=H(F(i.row,(p=t==null?void 0:t.value)==null?void 0:p.columns),w.value);if(h!==-1){const x=w.value[h];Object.assign(x.row,g),Object.assign(x.oldRow,g)}else await((R=e==null?void 0:e.loadData)==null?void 0:R.call(e))}else await((l=e==null?void 0:e.changePage)==null?void 0:l.call(e,u.page))},args:[A(o),a,{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(i,r,u){var p,R,l;const g=await m({row:i.oldRow,oldRow:i.row,rowMeta:i.rowMeta},r,void 0,!0);if(u.page===f.value.page&&u.pageSize===f.value.pageSize){const h=H(F(i.row,(p=t==null?void 0:t.value)==null?void 0:p.columns),w.value);if(h!==-1){const x=w.value[h];Object.assign(x.row,g),Object.assign(x.oldRow,g)}else await((R=e==null?void 0:e.loadData)==null?void 0:R.call(e))}else await((l=e==null?void 0:e.changePage)==null?void 0:l.call(e,u.page))},args:[A(o),a,{page:f.value.page,pageSize:f.value.pageSize}]},scope:M({view:_.value})}),Object.assign(o.row,n.columns.reduce((s,i)=>{var r;return(i.uidt===q.Formula||i.uidt===q.QrCode||i.uidt===q.Barcode||i.uidt===q.Rollup||i.au||(r=i.cdf)!=null&&r.includes(" on update "))&&(s[i.title]=D[i.title]),s},{})),Object.assign(o.oldRow,D)),await((c=e==null?void 0:e.globalCallback)==null?void 0:c.call(e)),D}catch(S){U.error(`${b("msg.error.rowUpdateFailed")} ${await W(S)}`)}finally{o.rowMeta&&(o.rowMeta.saving=!1)}}async function X(o,a,n,v={}){if(o.rowMeta&&(o.rowMeta.changed=!1),await le(()=>{var d,c;return!((d=o.rowMeta)!=null&&d.new&&((c=o.rowMeta)!=null&&c.saving))}).toMatch(d=>d),o.rowMeta.new)return await Q(o,n,v);a&&await m(o,a,v)}async function N(o,a,{metaValue:n=t.value,viewMetaValue:v=_.value}={},d=!1){var D;const c=[];for(const s of o)s.rowMeta&&(s.rowMeta.changed=!1),c.push(le(()=>{var i,r;return!((i=s.rowMeta)!=null&&i.new&&((r=s.rowMeta)!=null&&r.saving))}).toMatch(i=>i));await Promise.all(c);const S=[];for(const s of o){s.rowMeta&&(s.rowMeta.saving=!0);const i=F(s.row,n==null?void 0:n.columns),r=a.reduce((u,g)=>(u[g]=s.row[g],u),{});S.push({...r,...i})}await L.dbTableRow.bulkUpdate(V,n==null?void 0:n.project_id,n==null?void 0:n.id,S),d||K({redo:{fn:async function(i,r,u){var g,p,R;if(await N(i,r,{metaValue:n,viewMetaValue:v},!0),u.page===f.value.page&&u.pageSize===f.value.pageSize)for(const l of i){const h=H(F(l.row,(g=t==null?void 0:t.value)==null?void 0:g.columns),w.value);if(h!==-1){const x=w.value[h];Object.assign(x.row,l.row),Object.assign(x.oldRow,l.row)}else{await((p=e==null?void 0:e.loadData)==null?void 0:p.call(e));break}}else await((R=e==null?void 0:e.changePage)==null?void 0:R.call(e,u.page))},args:[A(o),A(a),{page:f.value.page,pageSize:f.value.pageSize}]},undo:{fn:async function(i,r,u){var g,p,R;if(await N(i,r,{metaValue:n,viewMetaValue:v},!0),u.page===f.value.page&&u.pageSize===f.value.pageSize)for(const l of i){const h=H(F(l.row,(g=t==null?void 0:t.value)==null?void 0:g.columns),w.value);if(h!==-1){const x=w.value[h];Object.assign(x.row,l.row),Object.assign(x.oldRow,l.row)}else{await((p=e==null?void 0:e.loadData)==null?void 0:p.call(e));break}}else await((R=e==null?void 0:e.changePage)==null?void 0:R.call(e,u.page))},args:[A(o.map(s=>({row:s.oldRow,oldRow:s.row,rowMeta:s.rowMeta}))),a,{page:f.value.page,pageSize:f.value.pageSize}]},scope:M({view:v})});for(const s of o)d||(Object.assign(s.row,n.columns.reduce((i,r)=>{var u;return(r.uidt===q.Formula||r.uidt===q.QrCode||r.uidt===q.Barcode||r.uidt===q.Rollup||r.au||(u=r.cdf)!=null&&u.includes(" on update "))&&(i[r.title]=s.row[r.title]),i},{})),Object.assign(s.oldRow,s.row)),s.rowMeta&&(s.rowMeta.saving=!1);await((D=e==null?void 0:e.globalCallback)==null?void 0:D.call(e))}async function fe(o,{metaValue:a=t.value,viewMetaValue:n=_.value}={}){var v,d;n&&(await L.dbTableRow.bulkUpdateAll(V,a==null?void 0:a.project_id,a==null?void 0:a.id,o,{viewId:n.id}),await((v=e==null?void 0:e.loadData)==null?void 0:v.call(e)),await((d=e==null?void 0:e.globalCallback)==null?void 0:d.call(e)))}const te=async(o,a,n,v,{metaValue:d=t.value}={})=>{try{await L.dbTableRow.nestedAdd(V,E.value.title,d==null?void 0:d.title,encodeURIComponent(o),v,n.title,encodeURIComponent(a))}catch(c){U.error(await W(c))}},ie=async(o,{metaValue:a=t.value}={})=>{var v;const n=G(o,a==null?void 0:a.columns);for(const d of(a==null?void 0:a.columns)??[]){if(d.uidt!==q.LinkToAnotherRecord)continue;const c=d.colOptions,S=(v=ee.value)==null?void 0:v[c==null?void 0:c.fk_related_model_id];if(xe(d)||Ce(d)){const D=o[d.title]??[];for(const s of D)await te(n,G(s,S.columns),d,c.type,{metaValue:a})}else Oe(d)&&o[d.title]&&await te(n,G(o[d.title],S.columns),d,c.type,{metaValue:a})}};async function B(o,{metaValue:a=t.value,viewMetaValue:n=_.value}={}){if(!o)throw new Error("Delete not allowed for table which doesn't have primary Key");const v=await L.dbViewRow.delete("noco",E.value.id,a==null?void 0:a.id,n==null?void 0:n.id,encodeURIComponent(o));return v.message?(U.info(`Row delete failed: ${`Unable to delete row with ID ${o} because of the following:
              
${v.message.join(`
`)}.

              Clear the data first & try again`})}`),!1):!0}async function Y(o,a){var n,v,d,c;try{const S=w.value[o];if(!S.rowMeta.new){const D=(v=(n=t==null?void 0:t.value)==null?void 0:n.columns)==null?void 0:v.filter(i=>i.pk).map(i=>S.row[i.title]).join("___");if(!await B(D))return;a||K({redo:{fn:async function(r){var p;await B(r);const u=F(S.row,(p=t==null?void 0:t.value)==null?void 0:p.columns),g=H(u,w.value);g!==-1&&w.value.splice(g,1),f.value.totalRows=f.value.totalRows-1},args:[D]},undo:{fn:async function(r,u,g){var R,l,h;const p=F(r.row,(R=t.value)==null?void 0:R.columns);r.row={...p,...r.row},await Q(r,u,{},!0),ie(r.row),o!==-1&&g.pageSize===f.value.pageSize?g.page===f.value.page?w.value.splice(o,0,r):await((l=e==null?void 0:e.changePage)==null?void 0:l.call(e,g.page)):await((h=e==null?void 0:e.loadData)==null?void 0:h.call(e))},args:[A(S),{},{page:f.value.page,pageSize:f.value.pageSize}]},scope:M({view:_.value})})}w.value.splice(o,1),await((d=e==null?void 0:e.syncCount)==null?void 0:d.call(e))}catch(S){U.error(`${b("msg.error.deleteRowFailed")}: ${await W(S)}`)}await((c=e==null?void 0:e.globalCallback)==null?void 0:c.call(e))}async function ve(){var n,v,d,c,S;let o=w.value.length;const a=[];for(;o--;)try{const{row:D,rowMeta:s}=w.value[o];if(!s.selected)continue;if(!s.new){const i=(v=(n=t==null?void 0:t.value)==null?void 0:n.columns)==null?void 0:v.filter(u=>u.pk).map(u=>D[u.title]).join("___");if(!await B(i))continue;a.push({id:i,row:A(w.value[o]),rowIndex:o})}w.value.splice(o,1)}catch(D){return U.error(`${b("msg.error.deleteRowFailed")}: ${await W(D)}`)}K({redo:{fn:async function(s){var i,r;for(const{id:u,row:g}of s){await B(u);const p=F(g.row,(i=t==null?void 0:t.value)==null?void 0:i.columns),R=H(p,w.value);R!==-1&&w.value.splice(R,1),f.value.totalRows=f.value.totalRows-1}await((r=e==null?void 0:e.syncPagination)==null?void 0:r.call(e))},args:[a]},undo:{fn:async function(s,i){var r,u,g;for(const{row:p,rowIndex:R}of s.slice().reverse()){const l=F(p.row,(r=t.value)==null?void 0:r.columns);p.row={...l,...p.row},await Q(p,{},{},!0),ie(p.row),R!==-1&&i.pageSize===f.value.pageSize?i.page===f.value.page?w.value.splice(R,0,p):await((u=e==null?void 0:e.changePage)==null?void 0:u.call(e,i.page)):await((g=e==null?void 0:e.loadData)==null?void 0:g.call(e))}},args:[a,{page:f.value.page,pageSize:f.value.pageSize}]},scope:M({view:_.value})}),await((d=e==null?void 0:e.syncCount)==null?void 0:d.call(e)),await((c=e==null?void 0:e.syncPagination)==null?void 0:c.call(e)),await((S=e==null?void 0:e.globalCallback)==null?void 0:S.call(e))}async function re(o){var c,S,D,s,i;if(!o._start||!o._end)return;const a=Math.max(o._start.row,o._end.row),n=Math.min(o._start.row,o._end.row);let v=a+1;const d=[];for(;v--;){try{const{row:r,rowMeta:u}=w.value[v];if(!u.new){const g=(S=(c=t==null?void 0:t.value)==null?void 0:c.columns)==null?void 0:S.filter(R=>R.pk).map(R=>r[R.title]).join("___");if(!await B(g))continue;d.push({id:g,row:A(w.value[v]),rowIndex:v})}w.value.splice(v,1)}catch(r){return U.error(`${b("msg.error.deleteRowFailed")}: ${await W(r)}`)}if(v===n)break}K({redo:{fn:async function(u){var g,p;for(const{id:R,row:l}of u){await B(R);const h=F(l.row,(g=t==null?void 0:t.value)==null?void 0:g.columns),x=H(h,w.value);x!==-1&&w.value.splice(x,1),f.value.totalRows=f.value.totalRows-1}await((p=e==null?void 0:e.syncPagination)==null?void 0:p.call(e))},args:[d]},undo:{fn:async function(u,g){var p,R,l;for(const{row:h,rowIndex:x}of u.slice().reverse()){const k=F(h.row,(p=t.value)==null?void 0:p.columns);h.row={...k,...h.row},await Q(h,{},{},!0),x!==-1&&g.pageSize===f.value.pageSize?g.page===f.value.page?w.value.splice(x,0,h):await((R=e==null?void 0:e.changePage)==null?void 0:R.call(e,g.page)):await((l=e==null?void 0:e.loadData)==null?void 0:l.call(e))}},args:[d,{page:f.value.page,pageSize:f.value.pageSize}]},scope:M({view:_.value})}),await((D=e==null?void 0:e.syncCount)==null?void 0:D.call(e)),await((s=e==null?void 0:e.syncPagination)==null?void 0:s.call(e)),await((i=e==null?void 0:e.globalCallback)==null?void 0:i.call(e))}return{insertRow:Q,updateRowProperty:m,addEmptyRow:ne,deleteRow:Y,deleteRowById:B,deleteSelectedRows:ve,deleteRangeOfRows:re,updateOrSaveRow:X,bulkUpdateRows:N,bulkUpdateView:fe,selectedAllRecords:oe,removeRowIfNew:o=>{const a=w.value.indexOf(o);return a>-1&&o.rowMeta.new?(w.value.splice(a,1),!0):!1}}}const Je=C=>C.map(t=>({row:{...t},oldRow:{...t},rowMeta:{}}));function be(C,t,_){if(!C)throw new Error("Table meta is not available");const{t:w}=ce(),f=je("optimisedQuery",()=>!0),{api:e,isLoading:b,error:we}=me(),ee=$e(),K=ee.currentRoute,{appInfo:A}=Te(),M=A.value.defaultLimit||25,E=Z({page:1,pageSize:M}),L=Z([]),oe=Z(),ne=Z(),Q=Z(),m=Z([]),X=Ae(Ee,Z(!1)),{project:N,isSharedBase:fe}=Se(ye()),{sharedView:te,fetchSharedViewData:ie,paginationData:B}=Ne(),{$api:Y,$e:ve}=De(),{sorts:re,nestedFilters:ge}=Be(),{isUIAllowed:o}=Ue(),a=de(()=>K.value.query),n=de({get:()=>X.value?B.value:E.value,set:y=>{X.value?B.value=y:E.value=y}}),v=de(()=>({offset:((n.value.page??0)-1)*(n.value.pageSize??M),limit:n.value.pageSize??M,where:(_==null?void 0:_.value)??""}));async function d(){var I,z,O;const{count:y}=await Y.dbViewRow.count(V,(I=N==null?void 0:N.value)==null?void 0:I.id,(z=C==null?void 0:C.value)==null?void 0:z.id,(O=t==null?void 0:t.value)==null?void 0:O.id);n.value.totalRows=y}async function c(){var j;const y=((j=n.value)==null?void 0:j.totalRows)??1/0,I=n.value.pageSize??M,z=n.value.page??1,O=Math.ceil(y/I),T=Math.max(1,Math.min(O,z));z>T?i==null||i(T):await D({offset:(T-1)*I,where:_==null?void 0:_.value})}async function S(){var I,z,O,T,j,J;if(!o("commentsCount")||X.value||fe.value)return;const y=(z=(I=m.value)==null?void 0:I.filter(({rowMeta:{new:P}})=>!P))==null?void 0:z.map(({row:P})=>{var $;return G(P,($=C==null?void 0:C.value)==null?void 0:$.columns)});if(!(!(y!=null&&y.length)||y!=null&&y.some(P=>!P))){L.value=await Y.utils.commentCount({ids:y,fk_model_id:(O=C.value)==null?void 0:O.id});for(const P of m.value){const $=G(P.row,(T=C.value)==null?void 0:T.columns);P.rowMeta.commentCount=+(((J=(j=L.value)==null?void 0:j.find(ue=>ue.row_id===$))==null?void 0:J.count)||0)}}}async function D(y={}){var O,T,j,J;if((!((O=N==null?void 0:N.value)!=null&&O.id)||!((T=C.value)!=null&&T.id)||!((j=t.value)!=null&&j.id))&&!X.value)return;const I=X.value?await ie({sortsArr:re.value,filtersArr:ge.value}):await e.dbViewRow.list("noco",N.value.id,C.value.id,t.value.id,{...v.value,...y,...o("sortSync")?{}:{sortArrJson:JSON.stringify(re.value)},...o("filterSync")?{}:{filterArrJson:JSON.stringify(ge.value)},where:_==null?void 0:_.value});m.value=Je(I.list),n.value=I.pageInfo;const z=Math.max(1,Math.ceil(n.value.totalRows/n.value.pageSize));z<n.value.page&&await i(z),((J=t.value)==null?void 0:J.type)===Me.GRID&&S()}async function s(){var y,I;(y=t==null?void 0:t.value)!=null&&y.id&&(oe.value=X.value?(I=te.value)==null?void 0:I.view:await Y.dbView.galleryRead(t.value.id))}async function i(y){n.value.page=y,await D({offset:(y-1)*(n.value.pageSize||M),where:_==null?void 0:_.value}),ve("a:grid:pagination")}const{insertRow:r,updateRowProperty:u,addEmptyRow:g,deleteRow:p,deleteRowById:R,deleteSelectedRows:l,deleteRangeOfRows:h,updateOrSaveRow:x,bulkUpdateRows:k,bulkUpdateView:ae,selectedAllRecords:se,removeRowIfNew:he}=Le({meta:C,viewMeta:t,formattedData:m,paginationData:n,callbacks:{changePage:i,loadData:D,syncCount:d,syncPagination:c}});async function ze(){var y,I,z;if((y=t==null?void 0:t.value)!=null&&y.id)try{const{columns:O,...T}=await Y.dbView.formRead(t.value.id),j=(O||[]).reduce((P,$)=>({...P,[$.fk_column_id]:$}),{});let J=1;Q.value=T,ne.value=(z=(I=C==null?void 0:C.value)==null?void 0:I.columns)==null?void 0:z.map(P=>{var $;return{...P,fk_column_id:P.id,fk_view_id:($=t.value)==null?void 0:$.id,...j[P.id]?j[P.id]:{},order:j[P.id]&&j[P.id].order||J++,id:j[P.id]&&j[P.id].id}}).sort((P,$)=>P.order-$.order)}catch(O){return U.error(`${w("msg.error.setFormDataFailed")}: ${await W(O)}`)}}async function Ie(y){var I;try{if(!((I=t==null?void 0:t.value)!=null&&I.id)||!y)return;await Y.dbView.formUpdate(t.value.id,y)}catch(z){return U.error(`${w("msg.error.formViewUpdateFailed")}: ${await W(z)}`)}}function pe(){return m.value.findIndex(y=>{var I;return a.value.rowId===G(y.row,(I=C.value)==null?void 0:I.columns)})}return{error:we,isLoading:b,loadData:D,paginationData:n,queryParams:v,formattedData:m,insertRow:r,updateRowProperty:u,changePage:i,addEmptyRow:g,deleteRow:p,deleteRowById:R,deleteSelectedRows:l,deleteRangeOfRows:h,updateOrSaveRow:x,bulkUpdateRows:k,bulkUpdateView:ae,selectedAllRecords:se,syncCount:d,syncPagination:c,galleryData:oe,loadGalleryData:s,loadFormView:ze,formColumnData:ne,formViewData:Q,updateFormView:Ie,aggCommentCount:L,loadAggCommentsCount:S,removeRowIfNew:he,navigateToSiblingRow:async y=>{var j,J,P,$,ue;let z=pe()+(y===Re.NEXT?1:-1);for(;(J=(j=m.value[z])==null?void 0:j.rowMeta)!=null&&J.new;)z=z+(y===Re.NEXT?1:-1);const O=((P=n==null?void 0:n.value)==null?void 0:P.page)||1;if(z<0){if(O===1)return U.info(w("msg.info.noMoreRecords"));await i(O-1),z=m.value.length-1}else if(z>=m.value.length){if(($=n==null?void 0:n.value)!=null&&$.isLastPage)return U.info(w("msg.info.noMoreRecords"));await i(O+1),z=0}const T=G(m.value[z].row,(ue=C.value)==null?void 0:ue.columns);T&&ee.push({query:{...a.value,rowId:T}})},getExpandedRowIndex:pe,optimisedQuery:f}}export{Le as a,be as u};
