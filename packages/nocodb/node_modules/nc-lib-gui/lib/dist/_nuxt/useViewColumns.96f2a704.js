import{b as q}from"./index.5263eb1d.js";import{$ as N,r as b,cb as O,i as p,dg as g,aq as Q,f as z,fb as G}from"./entry.51f4e399.js";import{a as H,f as J}from"./useMetas.ba7abae7.js";import{u as K}from"./index.9e760c64.js";function I(e,a,c){const C=N(q,b(!1)),t=b(),A=b(""),{$api:_,$e:w}=z(),{isUIAllowed:F}=K(),{isSharedBase:S}=O(H()),{addUndo:U,defineViewScope:L}=J(),m=p(()=>C.value||!F("hideAllColumns")||!F("showAllColumns")||S.value),x=b([]),P=s=>{var u,l,i;return((u=e.value)==null?void 0:u.type)===G.MAP&&((i=(l=e.value)==null?void 0:l.view)==null?void 0:i.fk_geo_data_col_id)===s.id},n=p(()=>{var s;return(s=a.value)!=null&&s.columns?a.value.columns.reduce((u,l)=>({...u,[l.id]:l}),{}):{}}),v=async()=>{var u,l,i,o;if(!a||!e)return;let s=1;if((u=e.value)!=null&&u.id){const V=(C.value?(l=a.value)==null?void 0:l.columns:(await _.dbViewColumn.list(e.value.id)).list).reduce((f,r)=>(r.show=!!r.show,{...f,[r.fk_column_id]:r}),{});if(t.value=(o=(i=a.value)==null?void 0:i.columns)==null?void 0:o.map(f=>{var h;const r=V[f.id]||{};return{title:f.title,fk_column_id:f.id,...r,show:r.show||P(r),order:r.order||s++,system:g((h=n==null?void 0:n.value)==null?void 0:h[r.fk_column_id]),isViewEssentialField:P(f)}}).sort((f,r)=>f.order-r.order),m.value&&t.value)for(const f of x.value){const r=t.value.findIndex(h=>h.fk_column_id===f.fk_column_id);r!==void 0&&r>-1&&(t.value[r]=f,t.value=t.value.sort((h,T)=>h.order-T.order))}}},j=async s=>{var u,l;if(m.value){t.value=(u=t.value)==null?void 0:u.map(i=>({...i,show:!0})),c==null||c();return}(l=e==null?void 0:e.value)!=null&&l.id&&(s?await _.dbView.showAllColumn(e.value.id,{ignoreIds:s}):await _.dbView.showAllColumn(e.value.id)),await v(),c==null||c(),w("a:fields:show-all")},E=async s=>{var u,l;if(m.value){t.value=(u=t.value)==null?void 0:u.map(i=>({...i,show:!!i.isViewEssentialField})),c==null||c();return}(l=e==null?void 0:e.value)!=null&&l.id&&(s?await _.dbView.hideAllColumn(e.value.id,{ignoreIds:s}):await _.dbView.hideAllColumn(e.value.id)),await v(),c==null||c(),w("a:fields:show-all")},k=async(s,u)=>{var l,i,o;if(m.value&&t.value&&(t.value[u]=s,a.value.columns=(l=a.value.columns)==null?void 0:l.map(d=>d.id===s.fk_column_id?{...d,...s,id:s.fk_column_id}:d),x.value.push(s)),F("fieldsSync")){if(s.id&&((i=e==null?void 0:e.value)!=null&&i.id))await _.dbViewColumn.update(e.value.id,s.id,s);else if((o=e.value)!=null&&o.id){const d=await _.dbViewColumn.create(e.value.id,s);return t.value&&(t.value[u]=d),d}}await v(),c==null||c()},y=p({get(){var s;return((s=e.value)==null?void 0:s.show_system_fields)||!1},set(s){var u;(u=e==null?void 0:e.value)!=null&&u.id&&(m.value||_.dbView.update(e.value.id,{show_system_fields:s}).finally(()=>{v(),c==null||c()}),e.value.show_system_fields=s),w("a:fields:system-fields")}}),$=p(()=>{var s;return((s=t.value)==null?void 0:s.filter(u=>{var l,i,o;return(i=(l=n==null?void 0:n.value)==null?void 0:l[u.fk_column_id])!=null&&i.pv?!0:!y.value&&g((o=n==null?void 0:n.value)==null?void 0:o[u.fk_column_id])?!1:A.value===""?!0:u.title.toLowerCase().includes(A.value.toLowerCase())}))||[]}),M=p(()=>{var s,u,l;return((l=(u=(s=t==null?void 0:t.value)==null?void 0:s.filter(i=>{var o,d,V,f,r;return!y.value&&n.value&&((o=n==null?void 0:n.value)!=null&&o[i.fk_column_id])&&g((d=n.value)==null?void 0:d[i.fk_column_id])&&!((f=(V=n.value)==null?void 0:V[i.fk_column_id])!=null&&f.pv)?!1:i.show&&((r=n==null?void 0:n.value)==null?void 0:r[i.fk_column_id])}))==null?void 0:u.sort((i,o)=>i.order-o.order))==null?void 0:l.map(i=>{var o;return(o=n==null?void 0:n.value)==null?void 0:o[i.fk_column_id]}))||[]}),R=(s,u)=>{var i;const l=(i=t.value)==null?void 0:i.findIndex(o=>o.fk_column_id===u.fk_column_id);!l&&l!==0||(U({undo:{fn:o=>{u.show=!o,k(u,l)},args:[s]},redo:{fn:o=>{u.show=o,k(u,l)},args:[s]},scope:L({view:e.value})}),k(u,l))};return Q([()=>{var s;return(s=e==null?void 0:e.value)==null?void 0:s.id},()=>{var s,u;return(u=(s=a.value)==null?void 0:s.columns)==null?void 0:u.length}],async([s])=>{var u,l;s&&((u=e.value)==null?void 0:u.fk_model_id)===((l=a.value)==null?void 0:l.id)&&await v()},{immediate:!0}),{fields:t,loadViewColumns:v,filteredFieldList:$,filterQuery:A,showAll:j,hideAll:E,saveOrUpdate:k,sortedAndFilteredFields:M,showSystemFields:y,metaColumnById:n,toggleFieldVisibility:R}}export{I as u};
