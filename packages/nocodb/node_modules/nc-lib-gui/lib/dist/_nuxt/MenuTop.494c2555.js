import{_ as ie}from"./ViewIcon.vue.9fe867dc.js";import{_ as re}from"./DeleteModal.vue.909e0964.js";import{h as te,T as ne,z as oe,o as x,C as $,w as h,E as i,c as A,b,a as D,t as se,W,H as X,J as K,K as Y,f as ae,$ as Z,r as w,cb as ce,U as de,aq as ee,cI as ue,aV as pe,I as G,cF as R,d as Q,fO as me,M as fe,Q as ve,R as we,g as _e,k as ye,aj as ge,cp as xe,gD as be,fb as he,N as ke}from"./entry.51f4e399.js";import{_ as Ie}from"./Icon.vue.1162f18b.js";import{_ as Ve}from"./Button.vue.793bcd1d.js";import{_ as De}from"./Dropdown.vue.97a9d1a0.js";import{A as le,d as Se}from"./index.5263eb1d.js";import{u as Ce}from"./sidebar.e289f4e1.js";import{u as $e}from"./index.9e760c64.js";import"./index.e760d172.js";import{I as Ee}from"./Input.7cb175ff.js";import{i as Me}from"./domUtils.b0dc23e8.js";import{d as Re,f as Te,p as Ne}from"./useMetas.ba7abae7.js";import{u as qe}from"./index.277e21b7.js";import{S as ze}from"./sortable.esm.9c3c89c5.js";import"./Modal.vue.b59a28af.js";import"./index.0db47614.js";import"./debounce.7d32c110.js";import"./toNumber.9dc54e53.js";import"./isSymbol.b53bd26f.js";import"./_plugin-vue_export-helper.c27b6911.js";import"./index.252dc7b4.js";import"./Dropdown.dc69c0a4.js";import"./RightOutlined.90e8180f.js";import"./SearchOutlined.dec109ce.js";import"./isPlainObject.ecf52d25.js";import"./_getPrototype.ec1165af.js";import"./TextArea.442a25cb.js";import"./antInputDirective.8ac36ea7.js";import"./FormItemContext.e001cd7c.js";import"./Password.d493e47a.js";const Pe={key:0,class:"flex flex-row items-center py-2 px-3 bg-gray-50 rounded-lg text-gray-700 mb-4"},Fe={class:"capitalize text-ellipsis overflow-hidden select-none w-full pl-3",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},Oe=te({__name:"ViewDelete",props:{modelValue:{type:Boolean},view:{}},emits:["update:modelValue","deleted"],setup(u,{emit:_}){const p=u,{view:t}=p,y=ne(p,"modelValue",_),{api:c}=oe(),{$e:E}=ae();async function M(){if(p.view)try{await c.dbView.delete(p.view.id),y.value=!1,_("deleted"),E("a:view:delete",{view:p.view.type})}catch(k){K.error(await Y(k))}}return(k,l)=>{const d=ie,I=re;return x(),$(I,{visible:i(y),"onUpdate:visible":l[0]||(l[0]=m=>X(y)?y.value=m:null),"entity-name":k.$t("objects.view"),"on-delete":M},{"entity-preview":h(()=>[i(t)?(x(),A("div",Pe,[b(d,{meta:p.view,class:"nc-view-icon"},null,8,["meta"]),D("div",Fe,se(i(t).title),1)])):W("",!0)]),_:1},8,["visible","entity-name"])}}}),je=ve(()=>we(()=>import("./EmojiPicker.4ea4095e.js"),["./EmojiPicker.4ea4095e.js","./entry.51f4e399.js","./entry.0f786d51.css","./ViewIcon.vue.9fe867dc.js","./ViewIcon.fd2d300a.css","./_plugin-vue_export-helper.c27b6911.js","./index.252dc7b4.js","./Dropdown.dc69c0a4.js","./RightOutlined.90e8180f.js","./EmojiPicker.6d557f4e.css"],import.meta.url).then(u=>u.default||u)),Be={class:"text-xs flex items-center w-full gap-1","data-testid":"view-item"},Ue=["data-testid"],Ae={key:1,class:"capitalize text-ellipsis overflow-hidden select-none w-full","data-testid":"sidebar-view-title",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},Ke=D("div",{class:"flex-1"},null,-1),Ge=["data-testid"],Le={class:"flex flex-row items-center gap-x-2 pl-2 text-xs"},He={class:"flex flex-row items-center gap-x-2 pl-1.5 text-xs"},Je={class:"flex flex-row items-center gap-x-2.25 pl-1.75 text-red-400 text-xs"},Qe=te({__name:"RenameableMenuItem",props:{view:{},onValidate:{type:Function}},emits:["update:view","selectIcon","changeView","rename","delete","openModal"],setup(u,{emit:_}){const p=u,t=ne(p,"view",_),{$e:y}=ae(),{isUIAllowed:c}=$e(),E=Z(le,w()),M=Z(Se,w(!1)),{rightSidebarState:k}=ce(Ce()),l=w(!1),d=w(!1),I=w(!1),m=w(),L=me(()=>{d.value||I.value||_("changeView",t.value)},250);function P(){var e;c("virtualViewsCreateOrEdit")&&(d.value||(d.value=!0,m.value=t.value.title,y("c:view:rename",{view:(e=t.value)==null?void 0:e.type})))}function V(e){e.key==="Escape"?T(e):e.key==="Enter"&&F(e)}function F(e){e.stopImmediatePropagation(),e.preventDefault(),O()}function T(e){e.stopImmediatePropagation(),e.preventDefault(),q()}de("Enter",e=>{d.value&&F(e)});const H=e=>e==null?void 0:e.focus();function J(){l.value=!1,_("openModal",{type:t.value.type,title:t.value.title,copyViewId:t.value.id,groupingFieldColumnId:t.value.view.fk_grp_col_id}),y("c:view:copy",{view:t.value.type})}async function N(){l.value=!1,_("delete",t.value)}async function O(){if(l.value=!1,!d.value)return;const e=p.onValidate({...t.value,title:m.value});if(e!==!0){K.error(e),q();return}if(t.value.title===""||t.value.title===m.value){q();return}const a=t.value.title;t.value.title=m.value||"",_("rename",t.value,a),j()}function q(){d.value&&j()}function j(){I.value=!0,d.value=!1,m.value="",setTimeout(()=>{I.value=!1},250)}return ee(k,()=>{k.value==="peekCloseEnd"&&(l.value=!1)}),(e,a)=>{const s=ie,n=je,o=Ee,f=Ie,g=Ve,C=De,B=fe,U=ue("e");return x(),$(B,{class:"!min-h-8 !max-h-8 !mb-0.25 select-none group text-gray-700 !flex !items-center !mt-0 !hover:bg-gray-100 !hover:text-gray-900","data-testid":`view-sidebar-view-${i(t).alias||i(t).title}`,onDblclick:R(P,["stop"]),onClick:i(L)},{default:h(()=>{var S,z,r;return[pe((x(),A("div",Be,[D("div",{class:"flex min-w-6","data-testid":`view-sidebar-drag-handle-${i(t).alias||i(t).title}`},[b(n,{class:"nc-table-icon",emoji:(z=(S=p.view)==null?void 0:S.meta)==null?void 0:z.icon,size:"small",clearable:!0,onEmojiSelected:a[0]||(a[0]=v=>_("selectIcon",v))},{default:h(()=>[b(s,{meta:p.view,class:"nc-view-icon"},null,8,["meta"])]),_:1},8,["emoji"])],8,Ue),i(d)?(x(),$(o,{key:0,ref:H,value:i(m),"onUpdate:value":a[1]||(a[1]=v=>X(m)?m.value=v:null),class:G(["!bg-transparent !text-xs !border-0 !ring-0 !outline-transparent !border-transparent",{"font-medium":((r=i(E))==null?void 0:r.id)===i(t).id}]),onBlur:O,onKeydown:a[2]||(a[2]=R(v=>V(v),["stop"]))},null,8,["value","class"])):(x(),A("div",Ae,se(i(t).alias||i(t).title),1)),Ke,!i(d)&&!i(M)&&i(c)("virtualViewsCreateOrEdit")?(x(),$(C,{key:2,visible:i(l),"onUpdate:visible":a[4]||(a[4]=v=>X(l)?l.value=v:null),"overlay-class-name":"!rounded-lg"},{overlay:h(()=>[D("div",{class:"flex flex-col items-center min-w-27","data-testid":`view-sidebar-view-actions-${i(t).alias||i(t).title}`},[b(g,{type:"text",size:"small",class:"w-full !rounded-none !hover:bg-gray-200",centered:!1,onClick:R(P,["stop"])},{default:h(()=>[D("div",Le,[b(f,{icon:"edit"}),Q(" Rename ")])]),_:1},8,["onClick"]),b(g,{type:"text",size:"small",class:"nc-view-copy-icon w-full !rounded-none !hover:bg-gray-200",centered:!1,onClick:R(J,["stop"])},{default:h(()=>[D("div",He,[b(f,{icon:"copy",class:"text-base"}),Q(" Duplicate ")])]),_:1},8,["onClick"]),i(t).is_default?W("",!0):(x(),$(g,{key:0,type:"text",size:"small",class:"nc-view-delete-icon w-full !hover:bg-gray-200 !rounded-none",centered:!1,onClick:R(N,["stop"])},{default:h(()=>[D("div",Je,[b(f,{icon:"delete"}),Q(" Delete ")])]),_:1},8,["onClick"]))],8,Ge)]),default:h(()=>[D("div",{class:G(["invisible !group-hover:visible",{"!visible":i(l)}])},[b(g,{type:"text",size:"xsmall",class:"nc-view-sidebar-node-context-btn !px-1 !hover:bg-gray-200",onClick:a[3]||(a[3]=R(v=>l.value=!i(l),["stop"]))},{default:h(()=>[b(f,{icon:"threeDotVertical",class:"-mt-0.5"})]),_:1})],2)]),_:1},8,["visible"])):W("",!0)])),[[U,["a:view:open",{view:i(t).type}]]])]}),_:1},8,["data-testid","onDblclick","onClick"])}}}),We=D("div",{class:"min-h-1 max-h-1 w-full bg-transparent"},null,-1),Ct=te({__name:"MenuTop",props:{views:{default:()=>[]}},emits:["openModal","deleted"],setup(u,{emit:_}){const{$e:p}=ae(),t=Z(le,w()),{api:y}=oe(),c=_e(),{refreshCommandPalette:E}=Re(),{addUndo:M,defineModelScope:k}=Te(),l=w([]),d=w(!1),I=w(),m=w(!1);ee(t,e=>{e&&e.id&&(l.value=[e.id])});function L(e){m.value=e,setTimeout(()=>{m.value=!1},300)}function P(e){return!e.title||e.title.trim().length<0?"View name is required":u.views.some(a=>a.title===e.title&&a.id!==e.id)?"View name should be unique":!0}let V;function F(e){e.stopImmediatePropagation(),e.preventDefault(),d.value=!0}async function T(e,a=!1){if(a||(e.stopImmediatePropagation(),e.preventDefault(),d.value=!1),u.views.length<2)return;const{newIndex:s=0,oldIndex:n=0}=e;if(s===n)return;a||M({redo:{fn:async()=>{const r=V.toArray(),v=r.splice(n,1);r.splice(s,0,v[0]),V.sort(r),await T(e,!0)},args:[]},undo:{fn:async()=>{const r=V.toArray(),v=r.splice(s,1);r.splice(n,0,v[0]),V.sort(r),await T({...e,oldIndex:s,newIndex:n},!0)},args:[]},scope:k({view:t.value})});const o=e.to.children,f=o[s-1],g=o[s+1],C=u.views.find(r=>r.id===e.item.id);if(!C||!C.id)return;const B=f?u.views.find(r=>r.id===f.id):{},U=g?u.views.find(r=>r.id===g.id):{};let S;u.views.length-1===s?S=parseFloat(String(B.order))+1:s===0?S=parseFloat(String(U.order))/2:S=(parseFloat(String(B.order))+parseFloat(String(U.order)))/2;const z=isNaN(Number(S))?n:S;C.order=z,await y.dbView.update(C.id,{order:z}),L(C.id),p("a:view:reorder")}const H=e=>{V&&V.destroy(),V=new ze(e,{ghostClass:"ghost",onStart:F,onEnd:T})};ye(()=>I.value&&H(I.value.$el));function J(e){c.currentRoute.value.query&&c.currentRoute.value.query.page&&c.currentRoute.value.query.page==="fields"?c.push({params:{viewTitle:e.id||""},query:c.currentRoute.value.query}):c.push({params:{viewTitle:e.id||""}}),e.type===he.FORM&&l.value[0]===e.id&&c.replace({query:{reload:"true"}}).then(()=>{c.replace({query:{}})})}async function N(e,a,s=!1){try{await y.dbView.update(e.id,{title:e.title,order:e.order}),await c.replace({params:{viewTitle:e.id}}),E(),s||M({redo:{fn:(n,o)=>{const f=n.title;n.title=o,N(n,f,!0)},args:[e,e.title]},undo:{fn:(n,o)=>{const f=n.title;n.title=o,N(n,f,!0)},args:[e,a]},scope:k({view:t.value})})}catch(n){K.error(await Y(n))}}function O(e){const a=w(!0),{close:s}=qe(Oe,{modelValue:a,view:e,"onUpdate:modelValue":n,onDeleted:()=>{n(),_("deleted"),E(),t.value===e&&c.replace({params:{viewTitle:u.views[0].id}})}});function n(){a.value=!1,s(1e3)}}const q=async(e,a)=>{try{a.meta={...Ne(a.meta),icon:e},y.dbView.update(a.id,{meta:a.meta}),p("a:view:icon:sidebar",{icon:e})}catch(s){K.error(await Y(s))}},j=()=>{var a;const e=document.querySelector(`.nc-views-menu [data-view-id="${(a=t.value)==null?void 0:a.id}"]`);e&&Me(e)&&(e==null||e.scrollIntoView({behavior:"auto",inline:"start"}))};return ee(()=>{var e;return(e=t.value)==null?void 0:e.id},()=>{var e;(e=t.value)!=null&&e.id&&setTimeout(()=>{j()},800)},{immediate:!0}),(e,a)=>{const s=Qe,n=ke;return x(),$(n,{ref_key:"menuRef",ref:I,class:G([{dragging:i(d)},"nc-views-menu flex flex-col !ml-3 w-full !border-r-0 !bg-inherit"]),"selected-keys":i(l)},{default:h(()=>[(x(!0),A(ge,null,xe(e.views,o=>{var f;return x(),$(s,{id:o.id,key:o.id,view:o,"on-validate":P,class:G(["nc-view-item !rounded-md !px-1.25 !py-0.5 w-full transition-all ease-in duration-300",{"bg-gray-200":i(m)===o.id,active:((f=i(t))==null?void 0:f.id)===o.id,[`nc-${o.type?i(be)[o.type]:o.type}-view-item`]:!0}]),"data-view-id":o.id,onChangeView:J,onOpenModal:a[0]||(a[0]=g=>e.$emit("openModal",g)),onDelete:O,onRename:N,onSelectIcon:g=>q(g,o)},null,8,["id","view","class","data-view-id","onSelectIcon"])}),128)),We]),_:1},8,["class","selected-keys"])}}});export{Ct as default};
